# ParkView App 功能测试指南

## 📱 应用架构

ParkView 是一个基于区块链的去中心化停车位租赁平台,运行在 Mantle Sepolia 测试网上。

### 技术栈
- **框架**: React Native + Expo 54
- **路由**: Expo Router (文件路由)
- **区块链**: Mantle Sepolia (Chain ID: 5003)
- **智能合约**: 0x32cE53dEd16b49d4528FeF7324Df1a77E7a64b55
- **Web3 库**: Viem 2.22.2
- **地图**: react-native-maps

---

## 🎯 功能测试清单

### 1. 地图总览 (首页标签)

#### ✅ 功能说明
从 Mantle Sepolia 链上实时获取所有车位数据并在地图上显示。

#### 📋 测试步骤
1. 打开 App,默认显示地图总览页面
2. 查看地图中心是否定位在**北京天安门**附近 (39.9042°N, 116.4074°E)
3. 查看顶部信息栏,应显示 "📍 链上车位数量: 9"
4. 在地图上应能看到 **9 个标记点**:
   - 🟢 绿色标记 = 可租用车位 (5个)
   - 🔴 红色标记 = 已出租车位 (4个)
5. 点击任意标记,查看车位详情弹窗
6. 点击"🔄 刷新"按钮,重新从链上获取数据

#### 🔍 验证点
- [ ] 地图加载成功
- [ ] 9 个标记点全部显示
- [ ] 标记颜色正确(绿色/红色)
- [ ] 点击标记显示详情
- [ ] 详情包含: 名称、位置、租金、状态、车主地址
- [ ] 刷新功能正常

#### 📊 已知数据
根据链上数据,应该能看到以下车位:
- 默认车位 (大北京) - 已出租
- 南海停车场 - 可租用
- 中海停车位 - 已出租
- hello kit - 可租用
- sun (beijing) - 可租用
- 北京故宫 (2个) - 1个已出租,1个可租用
- 等...

---

### 2. 我的租赁 (第二个标签)

#### ✅ 功能说明
显示当前用户作为租客租用的所有车位,包括租期信息。

#### 📋 测试步骤

**未连接钱包时:**
1. 切换到"我的租赁"标签
2. 应显示 "请先连接钱包" 提示
3. 引导用户前往个人中心连接钱包

**连接钱包后:**
1. 切换到"我的租赁"标签
2. 查看是否显示租用的车位列表
3. 下拉刷新列表
4. 查看每个租赁车位的详情:
   - 车位名称和状态标签 (🟢 租赁中 / 🔴 已过期)
   - 位置信息和GPS坐标
   - 租金价格 (MNT/天)
   - 车主地址
   - 到期时间和剩余天数
5. 点击"在地图查看"按钮
6. 点击"终止租赁"按钮

#### 🔍 验证点
- [ ] 未连接钱包显示提示
- [ ] 连接钱包后显示租赁列表
- [ ] 租赁数量统计正确
- [ ] 剩余天数计算正确
- [ ] 快过期车位显示红色警告 (≤3天)
- [ ] 下拉刷新功能正常
- [ ] 按钮交互正常

#### 💡 测试地址
使用演示模式连接的地址: `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb8`

根据链上数据,该地址没有租用任何车位,所以会显示 "暂无租赁记录"。

要查看有租赁的效果,可以观察以下地址:
- `0x0ef93F94ce6ECbD1e7b30ba6113cfe2826409eE5` - 租用了 3 个车位
- `0xadA778c33B4CA3f5374D410396b84DE2B08CC567` - 租用了 1 个车位
- `0xA500Eca69baE6Ad1eBFB1d061b2577BAd873f228` - 租用了 1 个车位

---

### 3. 我的车位 (第三个标签)

#### ✅ 功能说明
显示当前用户作为车主创建的所有车位,并提供管理功能。

#### 📋 测试步骤

**未连接钱包时:**
1. 切换到"我的车位"标签
2. 应显示 "🔌 请先连接钱包" 提示

**连接钱包后:**
1. 切换到"我的车位"标签
2. 下拉刷新列表
3. 查看车位列表(如果有)
4. 点击右下角的 ➕ 按钮
5. 查看创建车位提示

#### 🔍 验证点
- [ ] 未连接钱包显示提示
- [ ] 下拉刷新功能正常
- [ ] 显示车位数量统计
- [ ] 创建按钮正常响应
- [ ] 车位卡片信息完整

#### 💡 测试地址
演示地址 `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb8` 没有创建任何车位。

要查看有车位的效果,链上数据显示:
- `0xadA778c33B4CA3f5374D410396b84DE2B08CC567` - 创建了 5 个车位
- `0x0ef93F94ce6ECbD1e7b30ba6113cfe2826409eE5` - 创建了 2 个车位
- `0xA500Eca69baE6Ad1eBFB1d061b2577BAd873f228` - 创建了 1 个车位

---

### 4. 个人中心 (第四个标签)

#### ✅ 功能说明
显示钱包连接状态、余额信息和应用设置。

#### 📋 测试步骤

**未连接钱包时:**
1. 切换到"个人中心"标签
2. 查看钱包状态区域,应显示 "🔌 未连接钱包"
3. 点击"连接钱包"按钮
4. 在弹出的对话框中选择"确定(演示)"
5. 查看连接成功后的信息

**连接钱包后:**
1. 查看钱包图标和地址
2. 查看余额显示 (MNT)
3. 测试"断开连接"按钮
4. 重新连接

**设置菜单:**
1. 点击"语言设置" - 查看控制台日志
2. 点击"关于我们" - 查看控制台日志
3. 点击"隐私政策" - 查看控制台日志
4. 点击"联系我们" - 查看控制台日志

#### 🔍 验证点
- [ ] 连接按钮可点击
- [ ] 演示模式对话框显示
- [ ] 连接后显示地址 (0x742d...5f0bEb8)
- [ ] 余额显示正确 (从链上获取)
- [ ] 断开连接功能正常
- [ ] 菜单项可点击
- [ ] 版本号显示 (Version 1.0.0)

#### 💡 演示钱包信息
- 地址: `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb8`
- 显示格式: `0x742d...5f0bEb8`
- 余额: 从 Mantle Sepolia 链上实时获取

---

## 🔧 调试功能

### 控制台日志

打开 Expo Go 后,可以在终端看到详细的调试日志:

**地图页面日志:**
```
=== 地图页面调试信息 ===
加载状态: false
错误信息: null
车位数量: 9
第一个车位数据: {...}
```

**合约调用日志:**
```
🔍 开始从链上获取车位数据...
合约地址: 0x32cE53dEd16b49d4528FeF7324Df1a77E7a64b55
链 ID: 5003
RPC URL: https://rpc.sepolia.mantle.xyz
✅ 成功获取车位数据: 9 个
第一个车位: {...}
```

**租赁页面日志:**
```
我的租赁车位: 0
```

### 测试脚本

可以运行以下命令直接查询链上数据:
```bash
node test-contract.js
```

这会显示所有 9 个车位的详细信息,包括:
- ID、名称、位置
- GPS 坐标 (转换后的实际坐标)
- 租金、车主、租客
- 租赁状态
- 创建时间

---

## 🐛 已知问题

### 1. 钱包连接为演示模式
**现象**: 点击"连接钱包"显示对话框,而不是 WalletConnect 二维码

**原因**: WalletConnect React Native SDK 在 Expo Go 中需要原生模块支持

**解决方案**: 
- 当前使用演示模式,固定地址 `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb8`
- 仍然会从链上获取真实余额
- 要使用真实钱包,需要创建开发构建:
  ```bash
  npx expo install expo-dev-client
  eas build --profile development --platform android
  ```

### 2. 写入操作未实现
**现象**: 点击"创建车位"、"租用"、"终止租赁"等按钮显示"功能开发中"

**原因**: 需要真实钱包连接才能发送交易

**计划**: 在实现真实钱包连接后,将实现这些功能

---

## 📊 性能指标

### 加载时间
- 首次启动: ~2-3秒
- 地图加载: ~1-2秒
- 链上数据获取: ~1-3秒 (取决于网络)

### 网络请求
- RPC 调用: `https://rpc.sepolia.mantle.xyz`
- 单次查询车位: ~500ms-1s
- 余额查询: ~200-500ms

---

## ✅ 完成的功能

- [x] 地图显示所有链上车位
- [x] 实时从 Mantle Sepolia 获取数据
- [x] 车位标记颜色区分 (可租用/已出租)
- [x] 车位详情展示
- [x] 我的租赁页面 (筛选用户租用的车位)
- [x] 我的车位页面 (筛选用户创建的车位)
- [x] 钱包连接 (演示模式)
- [x] 余额显示 (真实链上数据)
- [x] 下拉刷新功能
- [x] GPS 坐标转换 (链上整数 ÷ 1000000)

---

## 🚀 下一步计划

1. **实现真实钱包连接**
   - 创建 Expo 开发构建
   - 集成 WalletConnect v2
   - 支持 MetaMask、TokenPocket 等钱包

2. **实现合约写入操作**
   - mintParkingSpot - 创建车位
   - rentParkingSpot - 租用车位
   - terminateRental - 终止租赁
   - burnParkingSpot - 销毁车位

3. **创建车位表单**
   - 照片上传 (expo-image-picker)
   - GPS 定位 (expo-location)
   - 租金设置
   - 位置描述

4. **增强地图功能**
   - 用户当前位置定位
   - 附近车位推荐
   - 路线导航
   - 车位搜索

---

## 📞 技术支持

如遇到问题,请查看:
1. 终端控制台日志
2. Expo Go 错误提示
3. 运行 `node test-contract.js` 验证链上数据

**合约浏览器**: https://explorer.sepolia.mantle.xyz/address/0x32cE53dEd16b49d4528FeF7324Df1a77E7a64b55
